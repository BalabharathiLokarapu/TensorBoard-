dist: trusty
sudo: required

language: python
python:
  - "2.7"
  - "3.6"

os:
  - linux

branches:
  only:
    - master
    - /^\d+\.\d+(\.\d+)?(-\S*)?$/

env:
  # Keep this Bazel version in sync with the `versions.check` directive
  # near the top of our WORKSPACE file.
  #
  # Grab the BAZEL_SHA256SUM from the Bazel releases page; e.g.:
  # bazel-0.20.0-linux-x86_64.sha256
  - TF=NIGHTLY BAZEL=0.16.1 BAZEL_SHA256SUM=f1a855ca35043cdb360bba96ca51998a6277797c096b3390e787fdee07398959

cache:
  directories:
    - $HOME/.bazel-output-base

# Each bullet point is displayed in the Travis log as one collapsed line, which
# indicates how long it took. Travis will check the return code at the end. We
# can't use `set -e` in the YAML file since it might impact Travis internals.
# If inline scripts get too long, Travis surprisingly prints them twice.

before_install:
  # Travis pre-installs an old version of numpy. We uninstall it to
  # reduce the potential for strange behavior when upgrading in-place
  # for TensorFlow's numpy dependency.
  - pip uninstall -y numpy
  - pip freeze  # print installed distributions, for debugging purposes
  - |
    # Download Bazel
    bazel_binary="$(mktemp)" &&
    bazel_checksum_file="$(mktemp)" &&
    printf >"${bazel_checksum_file}" \
        '%s  %s\n' "${BAZEL_SHA256SUM}" "${bazel_binary}" &&
    for url in \
        "https://mirror.bazel.build/github.com/bazelbuild/bazel/releases/download/${BAZEL}/bazel-${BAZEL}-linux-x86_64" \
        "https://github.com/bazelbuild/bazel/releases/download/${BAZEL}/bazel-${BAZEL}-linux-x86_64" \
    ; do
      if \
          wget -t 3 -O "${bazel_binary}" "${url}" &&
          shasum -a 256 --check "${bazel_checksum_file}"; then
        break
      else
        rm -f "${bazel_binary}"
      fi
    done &&
    rm "${bazel_checksum_file}" &&
    [ -f "${bazel_binary}" ]
  - chmod +x "${bazel_binary}"
  - sudo mv "${bazel_binary}" /usr/local/bin/bazel
  - ./test_bazel_cc.sh "immediately after Bazel install"

  # Storing build artifacts in this directory helps Travis cache them. This
  # will sometimes cut latency in half, when we're lucky.
  - echo "startup --output_base=${HOME}/.bazel-output-base" >>~/.bazelrc

  # Travis Trusty Sudo GCE VMs have 2 cores and 7.5 GB RAM. These settings
  # help Bazel go faster and not OOM the system.
  - echo "startup --host_jvm_args=-Xms500m" >>~/.bazelrc
  - echo "startup --host_jvm_args=-Xmx500m" >>~/.bazelrc
  - echo "startup --host_jvm_args=-XX:-UseParallelGC" >>~/.bazelrc
  - echo "build --local_resources=400,2,1.0" >>~/.bazelrc
  - echo "build --worker_max_instances=2" >>~/.bazelrc

  # Make Bazel as strict as possible, so TensorBoard will build correctly
  # for users, regardless of their Bazel configuration.
  - echo "build --worker_verbose" >>~/.bazelrc
  - echo "build --worker_sandboxing" >>~/.bazelrc
  - echo "build --spawn_strategy=sandboxed" >>~/.bazelrc
  - echo "build --genrule_strategy=sandboxed" >>~/.bazelrc
  - echo "test --test_verbose_timeout_warnings" >>~/.bazelrc

  # It's helpful to see the errors on failure.
  - echo "build --verbose_failures" >>~/.bazelrc
  - echo "test --test_output=errors" >>~/.bazelrc

  - ./test_bazel_cc.sh "post .bazelrc config"

  # Who dares poison my cache?!
  #- find "${HOME}/.bazel-output-base" || true  # log too long, Travis kill job :-(
  - find "${HOME}/.bazel-output-base" \( -iname "*crosstool*" -o -iname "*toolchain*" \)
  - find "${HOME}/.bazel-output-base" -type f \( -iname "*crosstool*" -o -iname "*toolchain*" \) -print0 | xargs -0 awk 'BEGINFILE { printf "\n--- %s ---\n", FILENAME } 1'

install:
  - ./test_bazel_cc.sh "at top of 'install' section"
  - pip install flake8==3.5.0
  - pip install futures==3.1.1
  - pip install grpcio==1.6.3
  - pip install mock==2.0.0
  - ./test_bazel_cc.sh "after installing non-TF Pip packages"
  - |
    # Install TensorFlow
    case "${TF}" in
      RELEASE)
        pip install -I tensorflow
        ;;
      NIGHTLY)
        # TODO(@wchargin): Unpin once tensorflow/tensorflow#24867 is merged:
        # https://github.com/tensorflow/tensorflow/pull/24867
        pip install -I tf-nightly==1.13.0.dev20190104
        ;;
      *)
        pip install -I tensorflow=="${TF}"
        ;;
    esac
  - ./test_bazel_cc.sh "after installing TensorFlow"

before_script:
  - ./test_bazel_cc.sh "at top of 'before_script' section"
  # fail the build if there are Python syntax errors or undefined names
  - flake8 . --count --select=E901,E999,F821,F822,F823 --show-source --statistics
  # exit-zero treats all errors as warnings.  The GitHub editor is 127 chars wide
  # a comment of '# noqa' or better yet '# noqa: <error code>' added to the code to silence flake8
  - flake8 . --count --exit-zero --ignore=E111,E114 --max-complexity=10 --max-line-length=127 --statistics
  # Make sure we aren't accidentally including work-in-progress code.
  - tensorboard/tools/do_not_submit_test.sh
  # Make sure all necessary files have the license information.
  - tensorboard/tools/license_test.sh

# Commands in this section should only fail if it's our fault. Travis will
# categorize them as 'failed', rather than 'error' for other sections.
script:
  # Note: bazel test implies fetch+build, but this gives us timing.
  - ./test_bazel_cc.sh "at top of 'script' section"
  - bazel fetch //tensorboard/...
  - bazel build //tensorboard/...
  - bazel test //tensorboard/...
  - ./test_bazel_cc.sh "at bottom of 'script' section"

after_script:
  # Bazel launches daemons unless --batch is used.
  - bazel shutdown

before_cache:
  - |
    # Scrub tiny build artifacts not worth caching.
    find "${HOME}/.bazel-output-base" \
      -name \*.runfiles -print0 \
      -or -name \*.tar.gz -print0 \
      -or -name \*-execroot.json -print0 \
      -or -name \*-tsc.json -print0 \
      -or -name \*-params.pbtxt -print0 \
      -or -name \*-args.txt -print0 \
      -or -name \*.runfiles_manifest -print0 \
      -or -name \*.server_params.pbtxt -print0 \
      | xargs -0 rm -rf

notifications:
  email: false
