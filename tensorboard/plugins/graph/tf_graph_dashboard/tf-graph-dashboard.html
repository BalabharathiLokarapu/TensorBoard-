<!--
@license
Copyright 2016 The TensorFlow Authors. All Rights Reserved.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->

<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../tf-backend/tf-backend.html">
<link rel="import" href="../tf-dashboard-common/tf-dashboard-layout.html">
<link rel="import" href="../tf-graph-board/tf-graph-board.html">
<link rel="import" href="../tf-graph-controls/tf-graph-controls.html">
<link rel="import" href="../tf-graph-loader/tf-graph-loader.html">
<link rel="import" href="../tf-tensorboard/registry.html">
<link rel="import" href="../vz-sorting/vz-sorting.html">

<!--
tf-graph-dashboard displays a graph from a TensorFlow run.

It has simple behavior: Creates a url-generator and run-generator
to talk to the backend, and then passes the runsWithGraph (list of runs with
associated graphs) along with the url generator into tf-graph-board for display.

If there are multiple runs with graphs, the first run's graph is shown
by default. The user can select a different run from a dropdown menu.
-->
<dom-module id="tf-graph-dashboard">
<template>
<paper-dialog id="error-dialog" with-backdrop></paper-dialog>
<template is="dom-if" if="[[_datasetsEmpty(_datasets)]]">
  <div style="max-width: 540px; margin: 80px auto 0 auto;">
    <h3>No graph definition files were found.</h3>
    <p>
    To store a graph, create a
    <code>tf.summary.FileWriter</code>
    and pass the graph either via the constructor, or by calling its
    <code>add_graph()</code> method.
    You may want to check out the
    <a
      href="https://www.tensorflow.org/get_started/graph_viz"
    >graph visualizer tutorial</a>.
    <p>
    If youâ€™re new to using TensorBoard, and want to find out how
    to add data and set up your event files, check out the
    <a href="https://github.com/tensorflow/tensorboard/blob/master/README.md">README</a>
    and perhaps the <a href="https://www.tensorflow.org/get_started/summaries_and_tensorboard">TensorBoard tutorial</a>.
    <p>
    If you think TensorBoard is configured properly, please see
    <a href="https://github.com/tensorflow/tensorboard/blob/master/README.md#my-tensorboard-isnt-showing-any-data-whats-wrong">the section of the README devoted to missing data problems</a>
    and consider filing an issue on GitHub.
  </div>
</template>
<template is="dom-if" if="[[!_datasetsEmpty(_datasets)]]">
<tf-dashboard-layout>
<div class="sidebar">
  <tf-graph-controls id="controls"
        devices-for-stats="{{_devicesForStats}}"
        color-by-params="[[_colorByParams]]"
        stats="[[_stats]]"
        color-by="{{_colorBy}}"
        datasets="[[_datasets]]"
        render-hierarchy="[[_renderHierarchy]]"
        selected-dataset="{{_selectedDataset}}"
        selected-file="{{_selectedFile}}"
        selected-metadata-tag="{{_selectedMetadataTag}}"
  ></tf-graph-controls>
  <tf-graph-loader id="loader"
        datasets="[[_datasets]]"
        selected-dataset="[[_selectedDataset]]"
        selected-metadata-tag="[[_selectedMetadataTag]]"
        selected-file="[[_selectedFile]]"
        out-graph-hierarchy="{{_graphHierarchy}}"
        out-graph="{{_graph}}"
        out-stats="{{_stats}}"
        progress="{{_progress}}"
        out-hierarchy-params="{{_hierarchyParams}}"
  ></tf-graph-loader>
</div>
<div class="center">
    <tf-graph-board id="graphboard"
        devices-for-stats="[[_devicesForStats]]"
        color-by="[[_colorBy]]"
        color-by-params="{{_colorByParams}}"
        graph-hierarchy="[[_graphHierarchy]]"
        graph="[[_graph]]"
        hierarchy-params="[[_hierarchyParams]]"
        progress="[[_progress]]"
        all-steps-mode-enabled="{{allStepsModeEnabled}}"
        render-hierarchy="{{_renderHierarchy}}"
        selected-node="{{_selectedNode}}"
        stats="[[_stats]]"
    ></tf-graph-board>
</div>
</tf-dashboard-layout>
</template>
<style>

:host /deep/ {
  font-family: 'Roboto', sans-serif;
}

.center {
  position: relative;
  height: 100%;
}

paper-dialog {
  padding: 20px;
}

</style>
</template>
</dom-module>

<script>
/**
 * The (string) name for the run of the selected dataset in the graph dashboard.
 */
const RUN_STORAGE_KEY = 'run';

Polymer({
  is: 'tf-graph-dashboard',
  properties: {
    _datasets: Array,
    _renderHierarchy: {type: Object, observer: '_renderHierarchyChanged'},
    _requestManager: {
      type: Object,
      value: () => new tf_backend.RequestManager(),
    },
    _canceller: {
      type: Object,
      value: () => new tf_backend.Canceller(),
    },
    allStepsModeEnabled: Boolean,
    _selectedNode: Object,
    _isAttached: Boolean,
    // Whether this dashboard is initialized. This dashboard should only be initialized once.
    _initialized: Boolean,
    runs: Array,
    run: {
      type: String,
      notify: true,
      value: tf_storage.getStringInitializer(
          RUN_STORAGE_KEY, {
            defaultValue: '',
            useLocalStorage: false,
          }),
      observer: '_runObserver',
    },
    _selectedDataset: {
      type: Number,
      notify: true,
    },
  },
  listeners: {
    'node-toggle-expand': '_handleNodeToggleExpand',
  },
  observers: [
    '_maybeInitializeDashboard(_isAttached)',
    '_determineSelectedDataset(_datasets, run)',
    '_updateSelectedDatasetName(_datasets, _selectedDataset)',
  ],
  attached: function() {
    this.set('_isAttached', true);
  },
  detached: function() {
    this.set('_isAttached', false);
  },
  reload: function() {},
  _runObserver: tf_storage.getStringObserver(
      RUN_STORAGE_KEY, {
        defaultValue: '',
        polymerProperty: 'run',
        useLocalStorage: false,
      }),
  _fetchGraphRuns() {
    return this._requestManager.request(
        tf_backend.getRouter().pluginRoute('graphs', '/runs'));
  },
  _fetchRunMetadataTags() {
    return this._requestManager.request(
        tf_backend.getRouter().pluginRoute('graphs', '/run_metadata_tags'));
  },
  _graphUrl(run, limitAttrSize, largeAttrsKey) {
    const demoMode = tf_backend.getRouter().isDemoMode();
    const base = tf_backend.getRouter().pluginRoute('graphs', '/graph');
    const optional = (p) => (p != null && !demoMode || undefined) && p;
    const parameters = {
      'run': run,
      'limit_attr_size': optional(limitAttrSize),
      'large_attrs_key': optional(largeAttrsKey),
    };
    const extension = demoMode ? '.pbtxt' : '';
    return tf_backend.addParams(base, parameters) + extension;
  },
  _maybeInitializeDashboard: function(isAttached) {
    if (this._initialized || !isAttached) {
      // Either this dashboard is already initialized ... or we are not yet ready to initialize.
      return;
    }
    // Set this to true so we only initialize once.
    this._initialized = true;
    Promise.all([this._fetchGraphRuns(), this._fetchRunMetadataTags()])
      .then(result => {
        const runsWithGraph = result[0].sort(vz_sorting.compareTagNames);
        const runToMetadata = result[1];
        const datasets = _.map(runsWithGraph, runName => ({
          name: runName,
          path: this._graphUrl(
              runName, tf.graph.LIMIT_ATTR_SIZE, tf.graph.LARGE_ATTRS_KEY),
          runMetadata: _.map(
            (runToMetadata[runName] || []).sort(vz_sorting.compareTagNames),
            tag => ({
              tag: tag,
              path: tf_backend.addParams(
                tf_backend.getRouter().pluginRoute('graphs', '/run_metadata'),
                {tag: tag, run: runName}),
            })),
        }));
        this.set('_datasets', datasets);
      });
  },
  _determineSelectedDataset(datasets, run) {
    // By default, load the first dataset.
    if (!run) {
      // By default, load the first dataset. 
      this.set('_selectedDataset', 0);
      return;
    }
    
    // If the URL specifies a dataset, load it.
    const dataset = datasets.findIndex(d => d.name === run);
    if (dataset === -1) {
      // Tell the user if the dataset cannot be found to avoid misleading
      // the user.
      const dialog = this.$$('#error-dialog');
      dialog.textContent =
          `No dataset named "${run}" could be found.`;
      dialog.open();
      return;
    }

    this.set('_selectedDataset', dataset);
  },
  _updateSelectedDatasetName(datasets, selectedDataset) {
    this.set('run', datasets[selectedDataset].name);
  },
  _datasetsEmpty: function(datasets) {
    return !datasets || !datasets.length;
  },
  _renderHierarchyChanged: function(renderHierarchy) {
    // Reload any data on the graph when the render hierarchy (which determines which nodes are
    // rendered) changes.
    this.reload();
  },
});

tf_tensorboard.registerDashboard({
  plugin: 'graphs',
  elementName: 'tf-graph-dashboard',
  isReloadDisabled: true,
});

</script>
