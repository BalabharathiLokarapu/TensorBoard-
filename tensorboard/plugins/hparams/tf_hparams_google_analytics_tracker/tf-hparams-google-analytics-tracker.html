<link rel="import" href="../polymer/polymer.html">

<!--
  An element to wrap the analytics.js interface for Google Analytics.

  When the first element is created, this initializes analytics.js and creates
  a first tracker. If the name attribute is used, a named tracker is created,
  otherwise the default tracker is created.

  The web app then uses the send* methods to send tracking events. As an API
  helper, there is also a handleEvent method that can be used as a handler
  for the "google-analytics-tracking" JavaScript event. This allows decoupling
  of producers and the consumers.

  Example:

    <my-app on-google-analytics-tracking="$.tracker.handleEvent">
      <google-analytics-tracker id="tracker"
                                tracking-id="UA-12345-1"
                                options="{'appVersion': '1.0'}">
      </google-analytics-tracker>
      ...
    </my-app>

  any child of <my-app> can send an event like

    this.fire('google-analytics-tracking', {'hitType': 'pageview'});

  to make the tracker send it off to Google Analytics.

  @element google-analytics-tracker
-->
<script>
(function() {
  'use strict'

  Polymer({
    is: 'tf-hparams-google-analytics-tracker',

    properties: {
      // If non-null, used as the "name" option.
      name: {
        reflectToAttribute: true,
        value: null,
        type: String,
      },

      /**
       * Configuration fields to include when creating the tracker.
       *
       * See the Analytics.js Field Reference for documentation.
       *
       * @attribute options
       * @type {!Object}
       */
      options: {
        type: Object,
        value: function() { return {}; },
      },

      /**
       * Tracking ID assigned by Google Analytics.
       *
       * If empty, analytics requests will be silently ignored except for
       * logging to the JS console.
       *
       * @attribute trackingId
       * @type {string}
       */
      trackingId: {
        type: String,
      },

      /**
       * @type {?Object} The Google Analytics tracker, or null if not yet
       * initialized.
       */
      ga: { computed: 'computeGa(trackingId, name, options)' },
    },

    computeGa(trackingId, name, options) {
      if (trackingId === undefined || trackingId === "") {
        // Tracking will be disabled.
        return undefined;
      }
      let ga = newGa()

      // Create a clone of options we can modify.
      var opts = JSON.parse(JSON.stringify(options));

      if (name)
        opts['name'] = name;

      ga('create', trackingId, 'auto', opts);

      // Wrap the ga object if we are not using the default tracker.
      if (name) {
        var defaultGa = ga;

        // Create a wrapper function that changes "action" into "name.action".
        ga = function(action) {
          if (typeof action === 'function')
            return defaultGa.apply(defaultGa, arguments);

          var args = Array.prototype.slice.call(arguments);
          args[0] = name + '.' + action;

          return defaultGa.apply(defaultGa, args);
        };
        // Get is the property retriever, as defined on GA tracker objects.
        ga.get = function() {
          var t = defaultGa.getByName(name)
          return t.get.apply(t, arguments);
        }
      }
      return ga
    },

    /**
     * Event handler for google-analytics-tracking events.
     *
     * The "detail" field of the passed event is an object must be usable in
     * a call like "ga('send', e.detail)". This generally means it should
     * at least have a "hitType" field.
     *
     * @method handleEvent
     * @param {!CustomEvent} e The event to be processed.
     */
    handleEvent: function(e) {
      if (!this.ga) {
        console.warn('GA disabled: Would send', e.detail);
        return;
      }

      this.ga('send', e.detail);
    },

    /**
     * Send an "event" hit to Google Analytics.
     *
     * Due to the GA UI not easily displaying category, action and label
     * together, it is recommended that you repeat the category in the action:
     * c=Button, a=Click Button, l=Forward.
     *
     * @method sendEvent
     * @param {string} category The event category, e.g. "Button".
     * @param {string} action The type of interaction, e.g. "Click".
     * @param {string=} opt_label Further categorization, e.g. "Forward".
     * @param {number=} opt_value Non-negative. Useful to pass counts.
     */
    sendEvent: function(category, action, opt_label, opt_value) {
      if (!this.ga) {
        console.warn('GA disabled: Would send "event"',
                     category, action, opt_label, opt_value);
        return;
      }

      this.ga('send', 'event', category, action, opt_label, opt_value);
    },

    /**
     * Send a "pageview" hit to Google Analytics.
     *
     * This also passes the document fragment identifier, unlike the default
     * analytics.js API.
     *
     * @method sendPageView
     */
    sendPageView: function() {
      var page = window.location.pathname +
                 window.location.search +
                 window.location.hash;

      if (!this.ga) {
        console.warn('GA disabled: Would send "pageview"', page);
        return;
      }

      this.ga('send', 'pageview', {
        'page': page
      });
    },

    /**
     * Send a "timing" hit to Google Analytics.
     *
     * Due to the GA UI not easily displaying category, varname and label
     * together, it is recommended that you repeat the category in the varname:
     * c=jQuery, v=Load jQuery, l=Google CDN.
     *
     * @method sendTiming
     * @param {string} category A top-level categorization, e.g. "jQuery".
     * @param {string} varname Name of the metric, e.g. "Load".
     * @param {number} value The number of milliseconds of elapsed time.
     * @param {string=} opt_label Further categorization, e.g. "Google CDN".
     */
    sendTiming: function(category, varname, value, opt_label) {
      if (!this.ga) {
        console.warn('GA disabled: would send "timing"',
                     category, varname, value, opt_label);
        return;
      }

      this.ga('send', 'timing', category, varname, value, opt_label);
    }
  });

  /**
   * Create a new "ga" object the way it's prescribed by Google Analytics.
   *
   * Copied from Google Analytics, but styling applied to make the JS linter
   * happy.
   *
   * @return {!function(...)} a "ga" object proxy ready for use.
   */
  function newGa() {
    (function(i, s, o, g, r, a, m) {
      i['GoogleAnalyticsObject'] = r;
      i[r] = i[r] || function() {
        (i[r].q = i[r].q || []).push(arguments);
      };
      i[r].l = 1 * new Date();
      a = s.createElement(o), m = s.getElementsByTagName(o)[0];
      a.async = 1;
      // We're setting 'a.src' here indirectly, so the compiler won't complain
      // about a possible XSS-vulnerability. The assignement is safe since
      // we set it to a known compile-time constant (the analytics.js URL).
      const attr = "src";
      a[attr] = g;
      m.parentNode.insertBefore(a, m);
    })(window, document, 'script', '//www.google-analytics.com/analytics.js',
       'ga');

    // Since GA replaces window.ga once loaded, we need this indirection.
    // proxyGa should implement all ga object and tracker methods. See
    // https://developers.google.com/analytics/devguides/collection/analyticsjs/method-reference
    var proxyGa = function() {
      var ga = window['ga'];
      return ga.apply(ga, arguments);
    };
    // Returns the tracker object created with the given name.
    // A ga object method.
    proxyGa.getByName = function(name) {
      return window['ga'].getByName(name);
    };
    // Returns all the tracker objects created on the page. A ga object method.
    proxyGa.getAll = function() {
      return window['ga'].getAll();
    };
    // Returns a named property on the default tracker object. Makes
    // the returned object also be a tracker object (which is non-standard, but
    // useful.)
    proxyGa.get = function() {
      var t = window['ga'].getByName('t0');
      return t.get.apply(t, arguments);
    };

    return proxyGa;
  }
})();
</script>
