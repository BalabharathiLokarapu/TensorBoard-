<!--
@license
Copyright 2016 The TensorFlow Authors. All Rights Reserved.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->

<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../paper-listbox/paper-listbox.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../paper-dialog/paper-dialog.html">
<link rel="import" href="../paper-radio-group/paper-radio-group.html">
<link rel="import" href="../paper-tooltip/paper-tooltip.html">
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../tf-backend/tf-backend.html">
<link rel="import" href="../tf-dashboard-common/tensorboard-color.html">

<dom-module id="tf-lite-controls">
<template>
<style>
:host {
  font-size: 12px;
  color: gray;
  --paper-font-subhead: {
    font-size: 14px;
    color: gray;
  };
  --paper-dropdown-menu-icon: {
    width: 15px;
    height: 15px;
  };
  --paper-dropdown-menu-button: {
    padding: 0;
  };
  --paper-dropdown-menu-input: {
    padding: 0;
  };
  --paper-item-min-height: 30px;
}

paper-button[raised].keyboard-focus {
  font-weight: normal;
}

table {
  border-collapse: collapse;
  border-spacing: 0;
}

table td {
  padding: 0;
  margin: 0;
}

pre {
  font: 14px/20px Roboto Mono,monospace;
  margin: 16px 0;
  overflow-x: auto;
  padding: 8px;
  position: relative;
  background: #f7f7f7;
  color: #37474f;
}

.allcontrols {
  padding: 0 30px;
}

.legend-holder {
  background: #e9e9e9;
  border-top: 1px solid #ccc;
  color: #555;
  position: absolute;
  bottom: 0;
  left: 0;
  padding: 15px 23px;
  width: 100%;
}

.toggle-legend-button {
  max-height: 20px;
  max-width: 20px;
  padding: 0;
}

.toggle-legend-text {
  vertical-align: middle;
}

paper-radio-button {
  display: block;
  padding: 5px;
}

svg.icon {
  width: 60px;
  height: 18px;
}

.icon ellipse {
  rx: 10px;
  ry: 5px;
  stroke: #CCC;
  stroke-width: 1px;
  fill: #FFFFFF;
  cy: 10px;
}

.icon rect {
  height: 14px;
  width: 35px;
  rx: 5px;
  ry: 5px;
  stroke: #CCC;
  stroke-width: 2px;
  fill: #D9D9D9;
}

.domainValues {
  margin-bottom: 10px;
  width: 165px;
}

.domainStart {
  float: left;
}

.domainEnd {
  float: right;
}

.colorBox {
  width: 20px;
}

.image-icon {
  width: 24px;
  height: 24px;
}

.help-icon {
  height: 15px;
  margin: 0;
  padding: 0;
}
.copy-button {
  position: absolute;
  right:0px;
  top: 0px;
  padding: 6px;
}
.copy-button:hover {
  background: #ccc;
}

.gray {
  color: #666;
}

.title {
  font-size: 16px;
  margin: 8px 5px 8px 0;
  color: black;
}

.title small {
  font-weight: normal;
}

.deviceList,
.xlaClusterList {
  max-height: 200px;
  overflow-y: auto;
}

#file {
  padding: 8px 0;
}

.color-legend-row {
  clear: both;
  height: 20px;
  margin-top: 5px;
  position: relative;
}

.color-legend-row svg {
  position: absolute;
  top: -1px;
  width: 40px;
}

.color-legend-row span.color-legend-value {
  margin-left: 60px;
}

#grey-rect {
  fill: #eee;
  stroke: #a6a6a6;
}

#faded-rect {
  fill: url(#rectHatch);
  stroke: var(--tb-graph-faded);
}

#unfilled-rect {
  stroke: #a6a6a6;
}

.devices-checkbox input {
  text-align: left;
  vertical-align: middle
}

.button-text {
  text-transform: none;
  padding: 8px 18px 0 18px;
  font-size: 14px
}

.upload-button {
  width: 165px;
  height: 25px;
  text-transform: none;
  margin-top: 4px;
}

.iconbutton {
  padding: 2px;
  width: 30px;
  height: 30px;
  color: var(--paper-orange-500);
}

.hidden-input {
  height: 0px;
  width: 0px;
  overflow: hidden;
}

.allcontrols .control-holder {
  display: flex;
  clear: both;
}

.allcontrols .control-holder paper-radio-group {
  margin-top: 5px;
}

span.counter {
  font-size: 13px;
  color: gray;
}

table.control-holder {
  border: 0;
  border-collapse: collapse;
}

table.tf-graph-controls td.input-element-table-data {
  padding: 0 0 0 20px;
}

/** Override inline styles that suppress pointer events for disabled buttons. Otherwise, the */
/*  tooltips do not appear. */
#color-by-radio-group paper-radio-button {
  pointer-events: auto !important;
}

.legend-clarifier {
  color: #266236;
  cursor: help;
  display: inline-block;
  text-decoration: underline;
}

.legend-clarifier paper-tooltip {
  width: 150px;
}

paper-listbox {
  flex-grow: 1;
}

paper-listbox paper-item-body {
  max-width: 220px;
  overflow: hidden;
}

.item-icon-button {
  width: 30px;
  height: 30px;
  position: absolute;
  right: 10px;
}

/** Otherwise, polymer UI controls appear atop node search. */
tf-graph-node-search {
  z-index: 1;
  width: 100%;
}
</style>
<svg width="0" height="0">
  <defs>
    <g id="legend-rect">
      <rect x="1" y="1" stroke-width="2px" height="14" width="35" rx="5" ry="5"></rect>
    </g>
    <g id="grey-rect">
      <use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#legend-rect" />
    </g>
    <g id="faded-rect">
      <use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#legend-rect" />
    </g>
    <g id="unfilled-rect">
      <use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#legend-rect" />
    </g>
  </defs>
</svg>
<div class="allcontrols">
    <h2>Selected Node: [[ _formatSelectedNode(selectedNode) ]]</h2>
  <div class="control-holder">
    <tf-graph-node-search selected-node="{{selectedNode}}" render-hierarchy="[[renderHierarchy]]"></tf-graph-node-search>
  </div>
  <div class="control-holder">
    <paper-radio-group id="color-by-radio-group" selected="{{colorBy}}">
      <paper-radio-button name="structure">Structure</paper-radio-button>
      <paper-radio-button id="tflite-compatibility-radio-button" name="op_compatibility">
        TF Lite Compatibility
      </paper-radio-button>
    </paper-radio-group>
  </div>
  <h2>Step 1</h2>
  <div class="control-holder">
    <div class="title">Input Nodes <span class="counter">([[inputNodes.length]])</span></div>
    <paper-button raised class="text-button upload-button" on-click="addInputNode">Add Selected Node</paper-button>
  </div>
  <div class="control-holder">
    <paper-listbox id="command-config-input-nodes" on-selected-changed="changeSelectedNode">
      <template is="dom-repeat" items="[[inputNodes]]">
        <paper-item>
          <paper-item-body>[[item.value]]</paper-item-body>
          <paper-icon-button icon="clear" on-click="removeNode"></paper-icon-button>
        </paper-item>
      </template>
      <template is="dom-if" if="[[_inputNodesEmpty]]">
        <paper-item disabled>Add nodes first</paper-item>
      </template>
    </paper-listbox>
  </div>
  <h2>Step 2</h2>
  <div class="control-holder">
    <div class="title">Output Nodes <span class="counter">([[outputNodes.length]])</span></div>
    <paper-button raised class="text-button upload-button" on-click="addOutputNode">Add Selected Node</paper-button>
    </paper-button>
  </div>
  <div class="control-holder">
    <paper-listbox id="command-config-output-nodes" on-selected-changed="changeSelectedNode">
        <template is="dom-repeat" items="[[outputNodes]]">
          <paper-item>
            <paper-item-body>[[item.value]]</paper-item-body>
            <paper-icon-button icon="clear" on-click="removeNode"></paper-icon-button>
          </paper-item>
        </template>
        <template is="dom-if" if="[[_outputNodesEmpty]]">
          <paper-item disabled>Add nodes first</paper-item>
        </template>
    </paper-listbox>
  </div>
  <h2>Step 3</h2>
  <div class="control-holder">
      <div class="title">Batch size: </div>
      <paper-input type="number" min="1" auto-validate value="[[batchSize]]" error-message="Positive numbers only!" no-label-float>
  </div>
  <div class="control-holder">
      <div class="title">Checkpoint: </div>
      <paper-dropdown-menu label="Dinosaurs" no-label-float selected-item-label="{{selectedCheckpoint}}">
        <paper-menu class="dropdown-content" selected="0" slot="dropdown-content">
          <template is="dom-repeat" items="[[checkpoints]]">
          <paper-item>[[item.value]]</paper-item>
          </template>
        </paper-menu>
      </paper-dropdown-menu>
  </div>
  <h2>Step 4</h2>
  <div class="control-holder">
    <paper-icon-button icon="aspect-ratio" class="iconbutton" on-click="convert" alt="Convert to TF Lite model">
    </paper-icon-button>
    <paper-button class="button-text" on-click="convert">Convert to TF Lite model
    </paper-button>
  </div>
  <div class="control-holder" style="padding-bottom: 60px">
    <paper-icon-button icon="aspect-ratio" class="iconbutton" on-click="generateCommand" alt="Generate command line">
    </paper-icon-button>
    <paper-button class="button-text" on-click="generateCommand">Generate command line
    </paper-button>
  </div>
  <div class="legend-holder">
    <paper-icon-button icon="[[_getToggleLegendIcon(_legendOpened)]]" on-click="_toggleLegendOpen" class="toggle-legend-button">
    </paper-icon-button>
    <span class="toggle-legend-text">
      [[_getToggleText(_legendOpened)]]
    </span>
    <iron-collapse opened="[[_legendOpened]]">
      <div>
        <table>
          <tr>
            <td>
              <div class="title">Graph</div>
            </td>
            <td>(* = expandable)</td>
          </tr>
          <tr>
            <td>
              <svg class="icon">
                <rect transform="translate(3, 1)" height="14" width="35" rx="5" ry="5" />
              </svg>
            </td>
            <td>
              Namespace<span class="gray">*</span>
              <div class="legend-clarifier">
                <span>?</span>
                <paper-tooltip animation-delay="0" position="right">
                  Encapsulates a set of nodes. Namespace is hierarchical and based on scope.
                </paper-tooltip>
              </div>
            </td>
          </tr>
          <tr>
            <td>
              <svg class="icon" preserveAspectRatio="xMinYMid meet" viewBox="0 0 10 10">
                <use xlink:href="#op-node-stamp" fill="white" stroke="#ccc" x="9.5" y="6" />
              </svg>
            </td>
            <td>
              OpNode
              <div class="legend-clarifier">
                <span>?</span>
                <paper-tooltip animation-delay="0" position="right">
                  Node that performs an operation. These nodes cannot expand.
                </paper-tooltip>
              </div>
            </td>
          </tr>
          <tr>
            <td>
              <svg class="icon" height="15px" preserveAspectRatio="xMinYMid meet" viewBox="0 0 12 12">
                <use xlink:href="#op-series-horizontal-stamp" fill="white" stroke="#ccc" x="2" y="2" />
              </svg>
            </td>
            <td>
              Unconnected series<span class="gray">*</span>
              <div class="legend-clarifier">
                <span>?</span>
                <paper-tooltip animation-delay="0" position="right">
                  Sequence of numbered nodes that are not connected to each other.
                </paper-tooltip>
              </div>
            </td>
          </tr>
          <tr>
            <td>
              <svg class="icon" height="15px" preserveAspectRatio="xMinYMid meet" viewBox="0 0 15 15">
                <use xlink:href="#op-series-vertical-stamp" fill="white" stroke="#ccc" x="2" y="2" />
              </svg>
            </td>
            <td>
              Connected series<span class="gray">*</span>
              <div class="legend-clarifier">
                <span>?</span>
                <paper-tooltip animation-delay="0" position="right">
                  Sequence of numbered nodes that are connected to each other.
                </paper-tooltip>
              </div>
            </td>
          </tr>
          <tr>
            <td>
              <svg class="icon">
                <circle fill="white" stroke="#848484" cx="10" cy="10" r="5" />
              </svg>
            </td>
            <td>
              Constant
              <div class="legend-clarifier">
                <span>?</span>
                <paper-tooltip animation-delay="0" position="right">
                  Node that outputs a constant value.
                </paper-tooltip>
              </div>
            </td>
          </tr>
          <tr>
            <td>
              <svg class="image-icon" viewBox="0 0 12 12" width="24" height="24">
                <use x="0" y="0" class="image-icon" xlink:href="#summary-icon" />
              </svg>
            </td>
            <td>
              Summary
              <div class="legend-clarifier">
                <span>?</span>
                <paper-tooltip animation-delay="0" position="right">
                  Node that collects data for visualization within TensorBoard.
                </paper-tooltip>
              </div>
            </td>
          </tr>
          <tr>
            <td>
              <svg class="icon" height="15px" preserveAspectRatio="xMinYMid meet" viewBox="0 0 15 15">
                <defs>
                  <marker id="dataflow-arrowhead-legend" fill="#bbb" markerWidth="10" markerHeight="10" refX="9"
                    refY="5" orient="auto-start-reverse">
                    <path d="M 0,0 L 10,5 L 0,10 C 3,7 3,3 0,0" />
                  </marker>
                </defs>
                <path marker-end="url(#dataflow-arrowhead-legend)" stroke="#bbb" d="M2 9 l 29 0" stroke-linecap="round" />
              </svg>
            </td>
            <td>
              Dataflow edge
              <div class="legend-clarifier">
                <span>?</span>
                <paper-tooltip animation-delay="0" position="right">
                  Edge showing the data flow between operations. Edges flow upwards unless arrowheads specify
                  otherwise.
                </paper-tooltip>
              </div>
            </td>
          </tr>
          <tr>
            <td>
              <svg class="icon" height="15px" preserveAspectRatio="xMinYMid meet" viewBox="0 0 15 15">
                <path stroke="#bbb" d="M2 9 l 29 0" stroke-linecap="round" stroke-dasharray="2, 2" />
              </svg>
            </td>
            <td>
              Control dependency edge
              <div class="legend-clarifier">
                <span>?</span>
                <paper-tooltip animation-delay="0" position="right">
                  Edge showing the control dependency between operations.
                </paper-tooltip>
              </div>
            </td>
          </tr>
          <tr>
            <td>
              <svg class="icon" height="15px" preserveAspectRatio="xMinYMid meet" viewBox="0 0 15 15">
                <defs>
                  <marker id="reference-arrowhead-legend" fill="#FFB74D" markerWidth="10" markerHeight="10" refX="9"
                    refY="5" orient="auto-start-reverse">
                    <path d="M 0,0 L 10,5 L 0,10 C 3,7 3,3 0,0" />
                  </marker>
                </defs>
                <path marker-end="url(#reference-arrowhead-legend)" stroke="#FFB74D" d="M2 9 l 29 0" stroke-linecap="round" />
              </svg>
            </td>
            <td>
              Reference edge
              <div class="legend-clarifier">
                <span>?</span>
                <paper-tooltip animation-delay="0" position="right">
                  Edge showing that the outgoing operation node can mutate the incoming tensor.
                </paper-tooltip>
              </div>
            </td>
          </tr>
        </table>
      </div>
    </iron-collapse>
  </div>
</div>
<paper-dialog id="command_dialog" with-backdrop>
    <h2>TFLite Convert Command</h2>
    <paper-dialog-scrollable>
        <pre id="command_text">{{convertCommand}}
        </pre>
        <a class="copy-button" title="Click to copy the command" on-click="copyCommand">
          <iron-icon icon="content-copy">
        </a>
    </paper-dialog-scrollable>
</paper-dialog>
<paper-dialog id="result_dialog" with-backdrop>
    <h2>TfLite Convert Result</h2>
    <paper-dialog-scrollable>
        <template is="dom-repeat" items="[[conversionMessages]]">
            <paper-item>
                <paper-item-body two-line>
                  <div>{{item.type}}:
                    <span inner-h-t-m-l="{{item.content.message}}"></span>
                    <template is="dom-if" if="{{conversionResult}}">
                      <a id="copy_generated_path_button" on-click="copyGeneratedPath" title="Click to copy the path"><iron-icon icon="content-copy"></iron-icon></a>
                    </template>
                    </div>
                  <template is="dom-if" if="[[item.content.suggestion]]">
                  <div secondary><{{item.content.suggestion}}</div>
                  </template>
                </paper-item-body>
                <iron-icon icon="{{conversionResult}}"></iron-icon>
            </paper-item>
          </template>
    </paper-dialog-scrollable>
</paper-dialog>
<paper-toast id="messageToast" always-on-top></paper-toast>
</template>
</dom-module>

<script>
  (function () { // Private scope.
    Polymer({
      is: 'tf-lite-controls',
      properties: {
        colorBy: {
          type: String,
          value: 'structure',
          notify: true,
          readonly: true
        },
        colorByParams: {
          type: Object,
          notify: true,
          readonly: true,
        },
        datasets: {
          type: Array
        },
        inputNodes: {
          type: Array,
          value: []
        },
        outputNodes: {
          type: Array,
          value: []
        },
        batchSize: {
          type: Number,
          value: 1
        },
        conversionMessages: {
          type: Array,
          value: []
        },
        conversionResult: {
          type: String,
          value: ''
        },
        convertCommand: {
          type: String,
          value: ''
        },
        renderHierarchy: {
          type: Object,
          notify: true,
        },
        selectedNode: {
          type: String,
          notify: true
        },
        selectedCheckpoint: {
          type: String,
          value: ''
        },
        checkpoints: {
          type: Array,
          value: []
        },
        _legendOpened: {
          type: Boolean,
          value: false,
        },
        _inputNodesEmpty: {
          type: Boolean,
          value: true
        },
        _outputNodesEmpty: {
          type: Boolean,
          value: true
        },
        _requestManager: {
          type: Object,
          value: () => new tf_backend.RequestManager(),
        }
      },
      ready() {
        this.getCheckpoints();
      },
      copyCommand: function(){
        this._copyHtml('command_text');
      },
      copyGeneratedPath: function() {
        this._copyHtml('generated_path');
      },
      addInputNode: function() {
        if(!this.selectedNode ) {
          this._showToast('Please selected a node in graph first.');
          return;
        }
        if(_.findIndex(this.inputNodes, o => o.value === this.selectedNode) > -1) {
          this._showToast('The selected node already exists in the list.')
          return;
        }
        this.push('inputNodes', {value:this.selectedNode, type: 'input'});
        this.set('_inputNodesEmpty', false);
      },
      addOutputNode: function() {
        if(!this.selectedNode) {
          this._showToast('Please selected a node in graph first.');
          return;
        }
        if(_.findIndex(this.outputNodes, o => o.value === this.selectedNode) > -1) {
          this._showToast('The selected node already exists in the list.')
          return;
        }
        this.push('outputNodes', {value:this.selectedNode, type: 'output'});
        this.set('_outputNodesEmpty', false);
      },
      removeNode: function(e) {
        this.splice(e.model.item.type + 'Nodes', e.model.index, 1);
        this.set('_' + e.model.item.type + 'NodesEmpty',
          this.get(e.model.item.type + 'Nodes').length === 0);
      },
      convert: function () {
        this._fetchRunToco().then(
          result => {
            this.conversionResult = result.hasOwnProperty('success');
            this.conversionMessages = this.conversionResult ? [{
              type: 'Congrats',
              content: {
                message: result.success
              }
            }] : result.errors;
            this.$.result_dialog.open();
          }
        )
      },
      generateCommand: function() {
        const inputs = this.inputNodes.map(x => x.value).join(',');
        const outputs = this.outputNodes.map(x => x.value).join(',');
        this._fetchTocoCommand().then(
          result => {
            this.convertCommand = result;
            this.$.command_dialog.open();

          }
        )
         = `tflite_convert --graph_def_file=my_frozen_mobilenet.pb
            --input_format=TENSORFLOW_GRAPHDEF
            --output_format=TFLITE
            --output_file=my_mobilenet_v1_1.0_224.tflite
            --inference_type=FLOAT
            --input_type=FLOAT
            --input_arrays=${inputs}
            --output_arrays=${outputs}`
      },
      getCheckpoints: function() {
        this._fetchCheckpoints().then(result=> {
          this.checkpoints = result.map(x => { return { value: x } });
        });
      },
      changeSelectedNode: function(e) {
        const nodesList = e.target.id.indexOf("input") >= 0 ? this.inputNodes : this.outputNodes;
        this.selectedNode = nodesList[e.detail.value].value;
      },
      _formatSelectedNode: function(text) {
        return text ? text : '[none]';
      },
      _toggleLegendOpen() {
        this.set('_legendOpened', !this._legendOpened);
      },
      _getToggleText(legendOpened) {
        return legendOpened ? "Close legend." : "Expand legend.";
      },
      _getToggleLegendIcon(legendOpened) {
        // This seems counter-intuitive, but actually makes sense because the
        // expand-more button points downwards, and the expand-less button points
        // upwards. For most collapsibles, this works because the collapsibles
        // expand in the downwards direction. This collapsible expands upwards
        // though, so we reverse the icons.
        return legendOpened ? "expand-more" : "expand-less";
      },
      _fetchRunToco() {
        const inputs = this.inputNodes.map(x => x.value);
        const outputs = this.outputNodes.map(x => x.value);
        return this._requestManager.request(
          tf_backend.getRouter().pluginRoute('lite', '/run_toco'), {
            data: JSON.stringify({
              input_nodes: inputs,
              output_nodes: outputs,
              batch_size: this.batchSize,
              checkpoint: this.selectedCheckpoint
            })
          });
      },
      _fetchCheckpoints() {
        return this._requestManager.request(
          tf_backend.getRouter().pluginRoute('lite', '/checkpoints')
        )
      },
      _fetchTocoCommand() {
        return this._requestManager.request(
          tf_backend.getRouter().pluginRoute('lite', ''), {
            data: JSON.stringify({
              input_nodes: inputs,
              output_nodes: outputs,
              batch_size: this.batchSize,
              checkpoint: this.selectedCheckpoint
            })
          });
      },
      _showToast(text) {
        this.$.messageToast.setAttribute('text', text);
        this.$.messageToast.open();
      },
      _copyHtml(domId) {
        const copyText = document.getElementById(domId);
        var range = document.getSelection().getRangeAt(0);
        range.selectNode(copyText);
        window.getSelection().addRange(range);
        document.execCommand("copy");
        this._showToast("Copied the text successfully.");
      }
    });
  })(); // Closing private scope.
</script>
