<link rel="import" href="tf-op-table.html">
<link rel="import" href="tf-op-details.html">
<link rel="import" href="utils.html">

<!--
  tf-op-profile is a view within the tf-profile-dashboard.
  It shows a hierarchical profile of XLA operations broken (a tf-op-table).
  A single item can be selected, and its details are shown (with tf-op-details).
  Summary information and the most expensive op are described at the top, as
  a gentle introduction.
-->
<dom-module id="tf-op-profile">
<template>
<style>
tf-op-details {
  position: fixed;
  top: 80px;
  right: 16px;
  width: 330px;
}
:host {
  display: block;
  margin-right: 350px;
}
</style>
<div class="tf-op-profile">
  <tf-op-details hidden="[[!_active]]" item="[[_active]]"></tf-op-details>
  <h4>Overall TPU utilization is
    <span style$="color:[[_textColor(_root)]]">[[_utilizationPercent(_root)]]</span>
  </h4>
  <p>Modifying your model's architecture, data dimensions, and improving the
  efficiency of CPU operations may help reach the TPU's FLOPS potential.</p>
  <h4>The most time was spent in a <b>[[_costlyOp.category]] operation</b>
    ([[_percent(_costlyOp.value)]])</h4>
  <p hidden$="[[_hasFlops(_costlyOp.op)]]">
    [[_costlyOp.op.name]] is
    <span style$="color:[[_textColor(_costlyOp.op)]];">overhead</span>,
    and a good target for optimization.
  </p>
  <!-- extra div to avoid HTML parsing bugs in polymer/vulcanize -->
  <div hidden$="[[!_hasFlops(_costlyOp.op)]]">
  <p>
    While active, [[_costlyOp.op.name]] uses
    <span style="color:[[_textColor(_costlyOp.op)]]">[[_utilizationPercent(_costlyOp.op)]]</span>
    of the computational potential of the chip.
    <span hidden$="[[_goodFlops(_costlyOp.op)]]">
      This is a good target for optimization.
    </span>
    <span hidden$="[[!_goodFlops(_costlyOp.op)]]">
      This is pretty good - other operations may be better targets for optimization.
    </span>
  </p>
  </div>
  <tf-op-table root-node="[[_root]]" active={{_active}}></tf-op-table>
</div>
</template>

<script>
import {RequestManager} from '../tf-backend/requestManager.js';
import {getRouter} from '../tf-backend/router.js';
import {flameColor, utilization, percent} from './utils.js';

Polymer({
  is: 'tf-op-profile',
  properties: {
    _requestManager: {
      type: Object,
      readOnly: true,
      value: () => new RequestManager(),
    },
    _data: {
      type: Object,
      notify: true,
    },
    _breakdown: {
      type: String,
      value: 'byCategory',
      notify: true,
    },
    _root: {
      type: Object,
      computed: '_getRoot(_data, _breakdown)',
      notify: true,
    },
    _active: {
      type: Object,
      value: null,
      notify: true,
    },
    run: {
      type: String,
      observer: '_runChanged'
    },
    _costlyOp: {
      type: Object,
      computed: '_worstOp(_data, "time")',
    },
  },
  _runChanged: function(run) {
    this._requestManager.request(
        getRouter().
            pluginRunTagRoute('profile', '/data')('op_profile', run)
    ).then((data) => {
      console.log("Loaded profile ", data);
      this._data = data;
    });
  },
  _getRoot: function(data, breakdown) { return data[breakdown]; },
  _percent: percent,
  _utilizationPercent: function(item) { return percent(utilization(item)); },
  _worstOp: function(data, metric) {
    var worst = null, worstValue = -Infinity, worstCategory = undefined;
    var category = [];
    function visit(node) {
      if (node.xla != null && node.metrics != null && node.metrics[metric] > worstValue) {
        worst = node;
        worstCategory = category[category.length - 1];
        worstValue = node.metrics[metric];
      }
      if (node.category != null) category.push(node.name);
      node.children.forEach(visit);
      if (node.category != null) category.pop();
    }
    visit(data.byCategory);
    console.log("Worst op is ", worst, worstCategory, worstValue);
    return {op: worst, category: worstCategory, value: worstValue};
  },
  _hasFlops: function(item) { return item.metrics.flops > 0; },
  _goodFlops: function(item) { return utilization(item) > 0.4; },
  _textColor: function(item) { return flameColor(utilization(item), 0.7); },
});
</script>
</dom-module>
